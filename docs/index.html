---

title: brown_phototour_revisited


keywords: fastai
sidebar: home_sidebar

summary: "The package for local patch descriptors evaluation, which takes into account image indexes and second nearest neighbor ratio (SNN) filtering strategy. It is in agreement with IMC benchmark and practice, unlike the original protocol."
description: "The package for local patch descriptors evaluation, which takes into account image indexes and second nearest neighbor ratio (SNN) filtering strategy. It is in agreement with IMC benchmark and practice, unlike the original protocol."
nb_path: "nbs/index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This file will become your README and also the index of your documentation.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>pip install brown_phototour_revisited</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There are 3 main modules of the package: dataset, extraction and benchmarking. 
To run the benchmark one needs two things:</p>
<ul>
<li>extract the desccriptors with either 'extract_pytorchinput_descriptors' or 'extract_numpyinput_descriptors'</li>
<li>get the mean average precision (mAP) with 'evaluate_mAP_snn_based'</li>
</ul>
<p>Here we will show how to evaluate several descriptors: Pytorch-based HardNet, OpenCV SIFT, skimage BRIEF.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>pip install kornia
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Requirement already satisfied: kornia in /home/mishkdmy/.local/lib/python3.7/site-packages (0.4.1+0c9e625)
Requirement already satisfied: numpy in /home/mishkdmy/.conda/envs/fastai1/lib/python3.7/site-packages (from kornia) (1.18.0)
Requirement already satisfied: torch&lt;1.7.0,&gt;=1.6.0 in /home/mishkdmy/.local/lib/python3.7/site-packages (from kornia) (1.6.0)
Requirement already satisfied: future in /home/mishkdmy/.local/lib/python3.7/site-packages (from torch&lt;1.7.0,&gt;=1.6.0-&gt;kornia) (0.18.2)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The code below will download the HardNet, trained on Liberty dataset, download the Notredame subset and extracts the local patch descriptors into the dict. Note, that we should not evaluate descriptor on the same subset, as it was trained on.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">kornia</span>

<span class="kn">from</span> <span class="nn">brown_phototour_revisited.dataset</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">brown_phototour_revisited.extraction</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">brown_phototour_revisited.benchmarking</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">kornia</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">HardNet</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="n">descs_out_dir</span> <span class="o">=</span> <span class="s1">&#39;data/descriptors&#39;</span>
<span class="n">download_dataset_to</span> <span class="o">=</span> <span class="s1">&#39;data/dataset&#39;</span>
<span class="n">patch_size</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># HardNet expects 32x32 patches</span>

<span class="n">desc_dict</span> <span class="o">=</span> <span class="n">extract_pytorchinput_descriptors</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
                                <span class="s1">&#39;HardNet+Liberty&#39;</span><span class="p">,</span>
                                <span class="n">subset</span><span class="o">=</span> <span class="s1">&#39;notredame&#39;</span><span class="p">,</span> 
                                <span class="n">path_to_save_dataset</span> <span class="o">=</span> <span class="n">download_dataset_to</span><span class="p">,</span>
                                <span class="n">path_to_save_descriptors</span> <span class="o">=</span> <span class="n">descs_out_dir</span><span class="p">,</span>
                                <span class="n">patch_size</span> <span class="o">=</span> <span class="n">patch_size</span><span class="p">,</span> 
                                <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre># Found cached data data/dataset/notredame.pt
data/descriptors/HardNet+Liberty_32px_notredame.npy already exists, loading
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span> <span class="p">(</span><span class="n">desc_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>dict_keys([&#39;descriptors&#39;, &#39;labels&#39;, &#39;img_idxs&#39;])
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Function <strong>extract_pytorchinput_descriptors</strong> expects <strong>torch.nn.Module</strong>, which takes (B, 1, patch_size, patch_size) torch.Tensor input and outputs (B, desc_dim) torch.Tensor.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we will calculate mAP.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mAP</span> <span class="o">=</span> <span class="n">evaluate_mAP_snn_based</span><span class="p">(</span><span class="n">desc_dict</span><span class="p">[</span><span class="s1">&#39;descriptors&#39;</span><span class="p">],</span>
                             <span class="n">desc_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span> 
                             <span class="n">desc_dict</span><span class="p">[</span><span class="s1">&#39;img_idxs&#39;</span><span class="p">],</span>
                             <span class="n">path_to_save_mAP</span> <span class="o">=</span> <span class="s1">&#39;data/mAP/HardNet+Liberty_notredame.npy&#39;</span><span class="p">,</span>
                            <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;pytorch-cuda&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">f</span><span class="s1">&#39;HardNetLib mAP on Notredame = </span><span class="si">{mAP:.5f}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='100' class='' max='100' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [100/100 00:38<00:00]
    </div>
    
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>HardNetLib mAP on Notredame = 0.61901
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we will evaluate OpenCV SIFT descriptor. 
Function <strong>extract_numpyinput_descriptors</strong> expects function or object, which takes (patch_size, patch_size) input and outputs (desc_dim) np.array.
As OpenCV doesn't provide such function, we will create it ourselves.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">patch_size</span> <span class="o">=</span> <span class="mi">65</span>
<span class="k">def</span> <span class="nf">get_center_kp</span><span class="p">(</span><span class="n">PS</span><span class="o">=</span><span class="mf">65.</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">PS</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">center_kp</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">KeyPoint</span><span class="p">()</span>
    <span class="n">center_kp</span><span class="o">.</span><span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
    <span class="n">center_kp</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">c</span><span class="o">/</span><span class="mf">5.303</span>
    <span class="k">return</span> <span class="n">center_kp</span>


<span class="n">sift</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
<span class="n">center_kp</span> <span class="o">=</span> <span class="n">get_center_kp</span><span class="p">(</span><span class="n">patch_size</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">extract_opencv_sift</span><span class="p">(</span><span class="n">patch</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">sift</span><span class="o">.</span><span class="n">compute</span><span class="p">((</span><span class="mi">255</span><span class="o">*</span><span class="n">patch</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),[</span><span class="n">center_kp</span><span class="p">])[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>

<span class="n">descs_out_dir</span> <span class="o">=</span> <span class="s1">&#39;data/descriptors&#39;</span>
<span class="n">download_dataset_to</span> <span class="o">=</span> <span class="s1">&#39;data/dataset&#39;</span>


<span class="n">desc_dict_sift</span> <span class="o">=</span> <span class="n">extract_numpyinput_descriptors</span><span class="p">(</span><span class="n">extract_opencv_sift</span><span class="p">,</span>
                                <span class="s1">&#39;OpenCV_SIFT&#39;</span><span class="p">,</span>
                                <span class="n">subset</span><span class="o">=</span> <span class="s1">&#39;notredame&#39;</span><span class="p">,</span> 
                                <span class="n">path_to_save_dataset</span> <span class="o">=</span> <span class="n">download_dataset_to</span><span class="p">,</span>
                                <span class="n">path_to_save_descriptors</span> <span class="o">=</span> <span class="n">descs_out_dir</span><span class="p">,</span>
                                <span class="n">patch_size</span> <span class="o">=</span> <span class="n">patch_size</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre># Found cached data data/dataset/notredame.pt
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='468159' class='' max='468159' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [468159/468159 03:45<00:00]
    </div>
    
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mAP_SIFT</span> <span class="o">=</span> <span class="n">evaluate_mAP_snn_based</span><span class="p">(</span><span class="n">desc_dict_sift</span><span class="p">[</span><span class="s1">&#39;descriptors&#39;</span><span class="p">],</span>
                             <span class="n">desc_dict_sift</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span> 
                             <span class="n">desc_dict_sift</span><span class="p">[</span><span class="s1">&#39;img_idxs&#39;</span><span class="p">],</span>
                            <span class="n">path_to_save_mAP</span> <span class="o">=</span> <span class="s1">&#39;data/mAP/OpenCV_SIFT65_notredame.npy&#39;</span><span class="p">,</span>
                            <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;pytorch-cuda&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">f</span><span class="s1">&#39;OpenCV SIFT PS = </span><span class="si">{patch_size}</span><span class="s1">, mAP on Notredame = </span><span class="si">{mAP_SIFT:.5f}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='100' class='' max='100' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [100/100 00:39<00:00]
    </div>
    
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>OpenCV SIFT PS = 65 mAP on Notredame = 0.45530
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now, let's try some binary descriptor, like BRIEF. Evaluation so far supports two metrics: <strong>euclidean</strong> and <strong>hamming</strong>.
Function <strong>extract_numpyinput_descriptors</strong> expects function or object, which takes (patch_size, patch_size) input and outputs (desc_dim) np.array.
As skimage doesn't provide exactly such function, we will create it ourselves by placing "detected" keypoint in the center of the patch.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="k">import</span> <span class="n">BRIEF</span>
<span class="n">patch_size</span> <span class="o">=</span> <span class="mi">65</span>
<span class="n">BR</span> <span class="o">=</span> <span class="n">BRIEF</span><span class="p">(</span><span class="n">patch_size</span> <span class="o">=</span> <span class="n">patch_size</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">extract_skimage_BRIEF</span><span class="p">(</span><span class="n">patch</span><span class="p">):</span>
    <span class="n">BR</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">patch_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">BR</span><span class="o">.</span><span class="n">descriptors</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">desc_dict_brief</span> <span class="o">=</span> <span class="n">extract_numpyinput_descriptors</span><span class="p">(</span><span class="n">extract_skimage_BRIEF</span><span class="p">,</span>
                                <span class="s1">&#39;skimage_BRIEF&#39;</span><span class="p">,</span>
                                <span class="n">subset</span><span class="o">=</span> <span class="s1">&#39;notredame&#39;</span><span class="p">,</span> 
                                <span class="n">path_to_save_dataset</span> <span class="o">=</span> <span class="n">download_dataset_to</span><span class="p">,</span>
                                <span class="n">path_to_save_descriptors</span> <span class="o">=</span> <span class="n">descs_out_dir</span><span class="p">,</span>
                                <span class="n">patch_size</span> <span class="o">=</span> <span class="n">patch_size</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre># Found cached data data/dataset/notredame.pt
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='468159' class='' max='468159' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [468159/468159 05:16<00:00]
    </div>
    
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That's will take a while.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mAP_BRIEF</span> <span class="o">=</span> <span class="n">evaluate_mAP_snn_based</span><span class="p">(</span><span class="n">desc_dict_brief</span><span class="p">[</span><span class="s1">&#39;descriptors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">),</span>
                             <span class="n">desc_dict_brief</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span> 
                             <span class="n">desc_dict_brief</span><span class="p">[</span><span class="s1">&#39;img_idxs&#39;</span><span class="p">],</span>
                             <span class="n">path_to_save_mAP</span> <span class="o">=</span> <span class="s1">&#39;data/mAP/skimageBRIEF_notredame.npy&#39;</span><span class="p">,</span>
                             <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span>
                             <span class="n">distance</span><span class="o">=</span><span class="s1">&#39;hamming&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">f</span><span class="s1">&#39;skimage BRIEF PS = </span><span class="si">{patch_size}</span><span class="s1">, mAP on Notredame = </span><span class="si">{mAP_BRIEF:.5f}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='100' class='' max='100' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [100/100 12:50<00:00]
    </div>
    
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>skimage BRIEF PS = 65 mAP on Notredame = 0.44817
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The original Brown benchmark consider evaluation, similar to cross-validation: train descriptor on one subset, evaluate on two others, repeat for all, so 6 evaluations are required. 
For the handcrafted descriptors, or those, that are trained on 3rd party datasets, only 3 evaluations are necessary.</p>
<p>We have function, which does all these evaluations: <strong>full_evaluation</strong>, which internally calls the functions we discussed above.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">kornia</span>
<span class="kn">from</span> <span class="nn">brown_phototour_revisited.benchmarking</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">patch_size</span> <span class="o">=</span> <span class="mi">65</span> <span class="c1"># SIFT performs better with bigger patch size.</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">kornia</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">SIFTDescriptor</span><span class="p">(</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">rootsift</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

<span class="n">descs_out_dir</span> <span class="o">=</span> <span class="s1">&#39;data/descriptors&#39;</span>
<span class="n">download_dataset_to</span> <span class="o">=</span> <span class="s1">&#39;data/dataset&#39;</span>
<span class="n">results_dir</span> <span class="o">=</span> <span class="s1">&#39;data/mAP&#39;</span>
<span class="n">desc_dict</span> <span class="o">=</span> <span class="n">full_evaluation</span><span class="p">(</span><span class="n">model</span><span class="p">,</span>
                                <span class="s1">&#39;Kornia RootSIFT&#39;</span><span class="p">,</span>
                                <span class="n">path_to_save_dataset</span> <span class="o">=</span> <span class="n">download_dataset_to</span><span class="p">,</span>
                                <span class="n">path_to_save_descriptors</span> <span class="o">=</span> <span class="n">descs_out_dir</span><span class="p">,</span>
                                <span class="n">path_to_save_mAP</span> <span class="o">=</span> <span class="n">results_dir</span><span class="p">,</span>
                                <span class="n">patch_size</span> <span class="o">=</span> <span class="n">patch_size</span><span class="p">,</span> 
                                <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span><span class="p">),</span> 
                           <span class="n">distance</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span>
                           <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;pytorch-cuda&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre># Found cached data data/dataset/liberty.pt
data/descriptors/Kornia RootSIFT_3rdparty_65px_liberty.npy already exists, loading
Found saved results data/mAP/Kornia RootSIFT_3rdparty_liberty.npy, loading
Kornia RootSIFT trained on 3rdparty PS = 65 mAP on liberty = 0.48087
# Found cached data data/dataset/notredame.pt
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='1829' class='' max='1829' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [1829/1829 00:39<00:00]
    </div>
    
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='100' class='' max='100' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [100/100 00:45<00:00]
    </div>
    
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Kornia RootSIFT trained on 3rdparty PS = 65 mAP on notredame = 0.47713
Downloading http://icvl.ee.ic.ac.uk/vbalnt/yosemite.zip to data/dataset/yosemite.zip
# Extracting data data/dataset/yosemite.zip

# Caching data data/dataset/yosemite.pt
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='2475' class='' max='2475' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [2475/2475 00:53<00:00]
    </div>
    
</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

    <div>
        <style>
            /* Turns off some styling */
            progress {
                /* gets rid of default border in Firefox and Opera. */
                border: none;
                /* Needs to be in here for Safari polyfill so background images work as expected. */
                background-size: auto;
            }
            .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
                background: #F44336;
            }
        </style>
      <progress value='193' class='' max='193' style='width:300px; height:20px; vertical-align: middle;'></progress>
      100.00% [193/193 00:34<00:00]
    </div>
    
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Kornia RootSIFT trained on 3rdparty PS = 65 mAP on yosemite = 0.56700
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you use the benchmark, please cite it:</p>

<pre><code>@misc{BrownRevisited2020,
  title={UBC PhotoTour Revisied},
  author={Mishkin, Dmytro},
  year={2020},
  url = {https://github.com/ducha-aiki/brown_phototour_revisited}
}</code></pre>

</div>
</div>
</div>
</div>
 

